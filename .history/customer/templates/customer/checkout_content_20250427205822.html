<!DOCTYPE html>


<div id="main-container" class="main-container">

    <div class="checkout-container">
        <div class="fillup-container">
            <div class="address-container">
                <div class="space-between">
                    <h1>Delivery address</h1>
                    <h3 id="edit-address" onclick="change()">Change</h3>
                </div>
               
                <div id="address-wrap-container" class="address-wrap-container">
                    <div class="map-wrap-container">
                        <div class="map-cover">
                            
                        </div>
                        <div class="info">
                            <div class="wrapper1">
                                <img class="marker" src="{% static 'icons/marker.svg' %}">
                                <p class="street">Marawi City</p>
                            </div>
                            <div class="wrapper">
                                <p id="edit" class="edit">Edit</p>
                            </div>  
                            
                        </div>
                        <hr>
                       
                    </div>
                    <div class="address-form-container">
                        <h1>We're missing your street <span class="slash">/</span> House Number</h1>
                        <form method="POST" action="save-address.php">
                            <div class="input-container">
                                <div class="form-group">
                                    <input id="street" type="text" name="street" placeholder="" required>
                                    <label for="street" class="floating-label">Street</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" name="baranggay" placeholder="" required>
                                    <label for="address-details" class="floating-label">Baranggay</label>
                                </div>
                                <div class="form-group">
                                    <input type="text" name="note" placeholder="" required>
                                    <label for="note" class="floating-label">Note to rider e.g. &#8212; building, landmark</label>
                                </div>
                            </div>

                            <div class="radio-wrapper-container">
                                <h1>Add a Label</h1>                        
                                <div class="radio-wrapper">
                                    <div class="radio-option" onclick="selectImage('option1')">
                                        <input type="radio" id="option1" name="imageRadio" value="home" style="display:none;" required>
                                        <img src="{% static 'icons/home.svg' %}" alt="Home">
                                        <p>Home</p>
                                    </div>
                                    <div class="radio-option" onclick="selectImage('option2')">
                                        <input type="radio" id="option2" name="imageRadio" value="work" style="display:none;" required>
                                        <img src="{% static 'icons/work.svg' %}" alt="Home">
                                        <p>Work</p>
                                    </div>
                                    <div class="radio-option" onclick="selectImage('option3')">
                                        <input type="radio" id="option3" name="imageRadio" value="partner" style="display:none;" required>
                                        <img src="{% static 'icons/partner.svg' %}" alt="Home">
                                        <p>Partner</p>
                                    </div>
                                    <div class="radio-option" onclick="selectImage('option4')">
                                        <input type="radio" id="option4" name="imageRadio" value="other" style="display:none;" required>
                                        <img src="{% static 'icons/other.svg' %}" alt="Home">
                                        <p>Other</p>
                                    </div>
                                </div>
                            </div>
                            <button class="submit" type="submit">SUBMIT</button>
                        </form>

                    </div>
                </div>
                <div id="saved-address-container" class="saved-address-container">
                    <div class="label-container">
                        <img id="address-label" class="address-label" src="" alt="Address Label">
                        <p id="label"></p>
                    </div>
                    <div class="address-details-container">
                        <p id="street-details">{street}</p>
                        <p id="address-details">{address_details}</p>
                        <!-- <input type="textfield" id="note" value=""> -->
                        <div class="form-group">
                            <input id="note" type="text" name="note" placeholder="" value="" required>
                            <label for="note" class="floating-label">Note to rider e.g. &#8212; building, landmark</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="personal-details-container">
                
                <div class="space-between">
                    <h1>Personal Details</h1>
                    <h3 id="edit-details" onclick="edit()">Edit</h3>
                </div>
                <div id="personal-details-wrap-container"> 
                    <form method="POST" action="update-details.php">
                        <div class="input-container2">
                            <div class="form-group"> 
                            <input class="email" type="email" name="email" value="<?php echo htmlspecialchars($email); ?>">
                                <label for="email" class="floating-label">Email</label>
                                
                            </div>
                            <div class="align-container">
                                <div class="form-group">
                                    <input id="first-name" class="name" type="text" name="first-name" required  placeholder="" value="<?php echo htmlspecialchars($firstName); ?>">
                                    <label for="first-name" class="floating-label">First name</label>
                                </div>
                                <div class="form-group">
                                    <input id="last-name" class="name" type="text" name="last-name" required  placeholder="" value="<?php echo htmlspecialchars($lastName); ?>">
                                    <label for="last-name" class="floating-label">Last name</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <input class="number" type="text" name="number" required placeholder="" value="<?php echo htmlspecialchars($phoneNumber); ?>">
                                <label for="number" class="floating-label">Mobile Number</label>
                            </div>
                        </div>
                        <button class="submit" type="submit">SUBMIT</button>
                    </form>
                </div>
                <div id="update-details-container" class="update-details-container">
                    <div class="update-details">
                        <p id="first-last-name" class="bold-text">{first_name} . {last_name}</p>
                        <p id="updated-email">{email}</p>
                        <p id="updated-phone">{phone_number}</p>
                    </div>
                </div>
            </div>


            <div class="payment-container">
                <h1>Payment</h1>
                <form method="POST" action="update-status.php">
                    <ul class="filter-options">
                        <li>
                            <label>
                                <div class="wrapper4">
                                    <div class="wrapper5">
                                        <input id="maya" type="radio" name="payment_method" value="maya" required>
                                        <img class="payment-icon" src="{% static 'icons/maya.svg' %}">
                                        <p>Maya</p>
                                    </div>

                                    <div class="wrapper3">

                                    <p class="instruction-container" id="instruction-container">You will be redirected to GCash after checkout. After you've performed the payment, you will be redirected back to Foodpanda.</p>
                                    </div>
                                </div>
                            </label>
                        </li>
                        <li>
                            <label>
                                <input id="card" type="radio" name="payment_method" value="credit" required>
                                <img class="payment-icon" src="icons/credit.svg">
                                <p>Credit / Debit Card</p>
                            </label>
                        </li>
                        <li>
                            <label>
                                <input id="bank" type="radio" name="payment_method" value="bank" required>
                                <img class="payment-icon" src="icons/bank.svg">
                                <p>Link bank account</p>
                            </label>
                        </li>
                        <li>
                            <label>
                                <div class="wrapper4">
                                    <div class="wrapper5">
                                        <input id="cod"  type="radio" name="payment_method" value="cod" required>
                                        <img class="payment-icon" src="icons/cod.svg">
                                        <p>Cash On Delivery</p>
                                    </div>

                                    <div id="cod-instruction" class="wrapper3">
                                        <p class="instruction-container" id="instruction-container">You can't pay by a card to the rider upon delivery.</p>
                                    </div>
                                </div>
                               
                            </label>
                            <div class="voucher-container">
                                <img class="vouchers" src="icons/voucher.svg">
                                <p>Apply a voucher</p>
                            </div>
                        </li>
                    </ul>
                    <button id="place-order" class="submit" type="submit">Place order</button>
                </form>
            </div>
        </div>

        <div class="order-summary-container">
            <div class="order-summary">
                <h1>Your order from</h1>
                <p class="order-from"><?php echo htmlspecialchars($restaurant_name); ?> - <?php echo htmlspecialchars($baranggay); ?></p>

                <div id="item-summary" class="items-summary">
                    <?php foreach ($orderItems as $item): ?>
                        <div class="total-summary">
                            <p><?php echo $item['quantity']; ?> x <?php echo htmlspecialchars($item['product_name']); ?></p>
                            <p>&#8369;<?php echo number_format($item['price'], 2); ?></p>
                        </div>
                    <?php endforeach; ?>
                </div>

                <hr style="margin-bottom: 10px; margin-top: 30px; width: 100%; height: 1px; border: none; border-bottom: 1px solid #ccc;">

                <div class="total-summary">
                    <p>Subtotal</p>
                    <p id="sub-total">&#8369;<?php echo number_format($subtotal, 2); ?></p>
                </div>
                <div class="total-summary">
                    <p>Standard delivery</p>
                    <p>&#8369;39</p>
                </div>
                <div class="total-summary">
                    <p>Small order fee</p>
                    <p>&#8369;29</p>
                </div>
                <div id="total-summary" class="total-summary">
                    <p id="total-summary-p" class="total">Total</p>
                    <p class="total" id="total">
                        &#8369;<?php echo number_format($subtotal + 39 + 29, 2); ?>
                    </p>
                </div>
            </div>
        </div>

    </div>
    <div id="modal-container" class="modal-container">
        <div class="map-modal-container">
            <div class="map-modal">
                <div class="cta">
                    <div class="left">
                        <img class="marker" src="icons/marker.svg">
                        <h1>What's your exact location?</h1>
                    </div>
                    <div class="right">
                        <img id="close" class="close" src="icons/close.svg">
                    </div>
                
                </div>
                <p>Providing your location enables more accurate 
                    search and delivery ETA, seamless order tracking 
                    and personalised recommendations.
                </p>
                <div class="form-group">
                    <input type="text" name="street-house-number" placeholder="">
                    <label for="street-house-number" class="location-label">Enter your street and house number</label>
                </div>
            
                <div class="map-cover2">

                </div>
                <hr class="hr-button">
                <button id="submit-address" type="submit">SUBMIT</button>
            </div>
        </div>
    </div>
    
</div>


<script>

    document.getElementById('cod').addEventListener('click', function() {
        document.getElementById('cod-instruction').style.display = 'flex';
    });
    document.getElementById('maya').addEventListener('click', function() {
        document.getElementById('cod-instruction').style.display = 'none';
    });
    document.getElementById('card').addEventListener('click', function() {
        document.getElementById('cod-instruction').style.display = 'none';
    });
    document.getElementById('bank').addEventListener('click', function() {
        document.getElementById('cod-instruction').style.display = 'none';
    });

    function change() {
        document.getElementById('address-wrap-container').style.display = 'block';
        document.getElementById('saved-address-container').style.display = 'none';
        document.getElementById('edit-address').style.display = "none";
    }
    function edit() {
        console.log('clicked')
        document.getElementById('personal-details-wrap-container').style.display = 'block';
        document.getElementById('update-details-container').style.display = 'none';
        document.getElementById('edit-details').style.display = "none";
    }
    document.querySelector('.address-form-container form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('save-address.php', { 
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                   
                    document.getElementById('address-wrap-container').style.display = 'none';
                    document.getElementById('saved-address-container').style.display = 'flex';

                   
                    document.getElementById('address-label').src = `icons/${formData.get('imageRadio')}.svg`; // Set label icon
                    document.getElementById('label').textContent = formData.get('imageRadio'); // Set street
                    document.getElementById('street-details').textContent = formData.get('street'); // Set street
                    document.getElementById('address-details').textContent = `Address Details: ${formData.get('address-details')}`; // Set address details
                    document.getElementById('note').value = formData.get('note'); // Set note
                    document.getElementById('edit-address').style.display = "flex";
                } else {
                    alert(data.message); 
                }
            })
            .catch(error => console.error('Error:', error));
    });


    document.querySelector('.personal-details-container form').addEventListener('submit', function (e) {
        e.preventDefault(); 

        const formData = new FormData(this);

        fetch('update-details.php', { 
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('personal-details-wrap-container').style.display = 'none';
                    document.getElementById('update-details-container').style.display = 'flex';

                    
                    const firstName = formData.get('first-name');
                    const lastName = formData.get('last-name');
                    document.getElementById('first-last-name').textContent = `${firstName} ${lastName}`;
                    document.getElementById('updated-email').textContent = formData.get('email'); // Set street
                    document.getElementById('updated-phone').textContent = formData.get('number'); // Set address details
                    document.getElementById('edit-details').style.display = "flex";

                } else {
                    alert(data.message); 
                }
            })
            .catch(error => console.error('Error:', error));
    });


  function selectImage(id) {

    const options = document.querySelectorAll('.radio-option');
    options.forEach(option => {
      option.classList.remove('selected');
    });


    const selectedOption = document.querySelector(`#${id}`).closest('.radio-option');
    selectedOption.classList.add('selected');


    const radioButton = document.getElementById(id);
    radioButton.checked = true;
  }

 

  function initMap() {
  
    const defaultLocation = { lat: 8.001106, lng: 124.284823 };

   
    const map = new google.maps.Map(document.querySelector('.map-cover2'), {
        center: defaultLocation,
        zoom: 15,
    });
    const map2 = new google.maps.Map(document.querySelector('.map-cover'), {
        center: defaultLocation,
        zoom: 15,
    });

   
    const marker = new google.maps.Marker({
        position: defaultLocation,
        map: map,
        draggable: true, 
        title: "Drag me to update your location",
    });

   
    const geocoder = new google.maps.Geocoder();


    function updateAddressFromLatLng(latlng) {
        geocoder.geocode({ location: latlng }, function (results, status) {
            if (status === "OK" && results[0]) {
               
                const address = results[0].formatted_address;
                document.querySelector('input[name="street-house-number"]').value = address;
            } else {
                console.error("Geocoder failed due to: " + status);
            }
        });
    }

    
    marker.addListener('dragend', function () {
        const position = marker.getPosition();
        updateAddressFromLatLng(position.toJSON());
    });

 
    map.addListener('click', function (event) {
        marker.setPosition(event.latLng);
        updateAddressFromLatLng(event.latLng.toJSON());
    });


    updateAddressFromLatLng(defaultLocation);
}


document.getElementById('edit').addEventListener('click', function () {
    document.getElementById('modal-container').style.display = 'flex';
    document.body.style.overflow = 'hidden';
});


document.getElementById('submit-address').addEventListener('click', function () {
    const selectedAddress = document.querySelector('input[name="street-house-number"]').value;
    document.querySelector('.street').textContent = selectedAddress; 
    document.getElementById('street').value = selectedAddress; // Hide the modal
    document.getElementById('modal-container').style.display = 'none'; 
    document.body.style.overflow = 'auto';
});

let activeIcon = null;


    function toggleIcon(icon) {
    
        if (activeIcon && activeIcon !== icon) {
            activeIcon.src = activeIcon.getAttribute("data-default");
        }
        

        icon.src = icon.getAttribute("data-active");
        activeIcon = icon;
    }

document.getElementById('close').setAttribute("data-default", "icons/close.svg");
document.getElementById('close').setAttribute("data-active", "icons/close2.svg");

document.getElementById('close').addEventListener('click', function() {
    
    console.log('clicked');
    document.getElementById('modal-container').style.display = 'none'; // Hide the modal
    document.body.style.overflow = 'auto';
    
});
document.getElementById('close').addEventListener('mouseover', function() {
    toggleIcon(this);
    console.log('hover');
    
    
});

document.getElementById('close').addEventListener('mouseout', function() {
    if (activeIcon === this) {
        this.src = this.getAttribute("data-default");
        activeIcon = null;  
    }
    console.log('hover');
    
    
});

document.getElementById("place-order").addEventListener("click", function () {



        const street = document.querySelector("#street").value.trim();
        const addressDetails = document.querySelector("input[name='address-details']").value.trim();
        const note = document.querySelector("input[name='note']").value.trim();
        const addressLabel = document.querySelector("input[name='imageRadio']:checked");

       
        const firstName = document.querySelector("#first-name").value.trim();
        const lastName = document.querySelector("#last-name").value.trim();
        const phoneNumber = document.querySelector("input[name='number']").value.trim();

 
        const paymentMethod = document.querySelector("input[name='payment_method']:checked");

     
        if (!street || !addressDetails || !note || !addressLabel) {
            alert("Please complete your delivery address details.");
        } else if (!firstName || !lastName || !phoneNumber) {
            alert("Please complete your personal details.");
        } else if (!paymentMethod) {
            alert("Please select a payment method.");
        } else {

            document.querySelector(".submit").closest("form").submit();
        }
    });

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCuDLJMhB-23kQiXYpXwi-yYGvKz7OgSQ&callback=initMap" async defer></script>