{% extends 'components/rider/dashboard_base.html' %}

{% load static %}

{% if not user.is_authenticated %}
    <script>window.location.href = "/";</script>
{% endif %}

{% block content %}

<!-- Navigation Page Container -->
<div class="navigation-container">
    <!-- Full Width Map -->
    <div id="map" class="map-container"></div>
    
    <!-- Back Button (Top Left) -->
    <button class="back-button" onclick="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 12H5M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    
    <!-- Live Tracking Indicator (Top Right) -->
    <div class="tracking-indicator" id="trackingIndicator">
        <div class="tracking-dot"></div>
        <span class="tracking-text">Live Tracking</span>
    </div>
    
    <!-- Zoom Controls (Top Right Below Tracking) -->
    <div class="zoom-controls">
        <button class="zoom-button zoom-in" onclick="zoomIn()" title="Zoom In">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="zoom-button zoom-out" onclick="zoomOut()" title="Zoom Out">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    
    <!-- Bottom Container -->
    <div class="bottom-navigation-container">
        <div class="download-message">
            <div class="download-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="download-content">
                <h3>Get the Full Experience</h3>
                <p>Download our mobile app to access rider assignments, real-time order tracking, and exclusive rider features.</p>
                <div class="download-buttons">
                    <img class="google-play-download" src="{% static 'rider/images/googleplay.png' %}" alt="Download on Google Play">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps Script -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCuDLJMhB-23kQiXYpXwi-yYGvKz7OgSQ&libraries=geometry"></script>

<script>
    let map;
    let userMarker;
    let watchId;
    let isTracking = false;
    let currentLocation = null;

    // Custom map styles
    const mapStyles = [
        {
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#1d2c4d"
                }
            ]
        },
        {
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#8ec3b9"
                }
            ]
        },
        {
            "elementType": "labels.text.stroke",
            "stylers": [
                {
                    "color": "#1a3646"
                }
            ]
        },
        {
            "featureType": "administrative.country",
            "elementType": "geometry.stroke",
            "stylers": [
                {
                    "color": "#4b6878"
                }
            ]
        },
        {
            "featureType": "administrative.land_parcel",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "administrative.land_parcel",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#64779e"
                }
            ]
        },
        {
            "featureType": "administrative.neighborhood",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "administrative.province",
            "elementType": "geometry.stroke",
            "stylers": [
                {
                    "color": "#4b6878"
                }
            ]
        },
        {
            "featureType": "landscape.man_made",
            "elementType": "geometry.stroke",
            "stylers": [
                {
                    "color": "#334e87"
                }
            ]
        },
        {
            "featureType": "landscape.natural",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#023e58"
                }
            ]
        },
        {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#283d6a"
                }
            ]
        },
        {
            "featureType": "poi",
            "elementType": "labels.text",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "poi",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#6f9ba5"
                }
            ]
        },
        {
            "featureType": "poi",
            "elementType": "labels.text.stroke",
            "stylers": [
                {
                    "color": "#1d2c4d"
                }
            ]
        },
        {
            "featureType": "poi.business",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "poi.park",
            "elementType": "geometry.fill",
            "stylers": [
                {
                    "color": "#023e58"
                }
            ]
        },
        {
            "featureType": "poi.park",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#3C7680"
                }
            ]
        },
        {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#304a7d"
                }
            ]
        },
        {
            "featureType": "road",
            "elementType": "labels",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "road",
            "elementType": "labels.icon",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "road",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#98a5be"
                }
            ]
        },
        {
            "featureType": "road",
            "elementType": "labels.text.stroke",
            "stylers": [
                {
                    "color": "#1d2c4d"
                }
            ]
        },
        {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#2c6675"
                }
            ]
        },
        {
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [
                {
                    "color": "#255763"
                }
            ]
        },
        {
            "featureType": "road.highway",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#b0d5ce"
                }
            ]
        },
        {
            "featureType": "road.highway",
            "elementType": "labels.text.stroke",
            "stylers": [
                {
                    "color": "#023e58"
                }
            ]
        },
        {
            "featureType": "transit",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "transit",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#98a5be"
                }
            ]
        },
        {
            "featureType": "transit",
            "elementType": "labels.text.stroke",
            "stylers": [
                {
                    "color": "#1d2c4d"
                }
            ]
        },
        {
            "featureType": "transit.line",
            "elementType": "geometry.fill",
            "stylers": [
                {
                    "color": "#283d6a"
                }
            ]
        },
        {
            "featureType": "transit.station",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#3a4762"
                }
            ]
        },
        {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [
                {
                    "color": "#0e1626"
                }
            ]
        },
        {
            "featureType": "water",
            "elementType": "labels.text",
            "stylers": [
                {
                    "visibility": "off"
                }
            ]
        },
        {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [
                {
                    "color": "#4e6d70"
                }
            ]
        }
    ];

    // Initialize map
    function initMap() {
        // Default to Iligan City coordinates
        const iliganCity = { lat: 8.2474, lng: 124.2452 };
        
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 16,
            center: iliganCity,
            styles: mapStyles,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            zoomControl: true,
            zoomControlOptions: {
                position: google.maps.ControlPosition.RIGHT_BOTTOM
            }
        });

        // Start live location tracking
        startLiveTracking();
    }

    // Start live location tracking
    function startLiveTracking() {
        if (navigator.geolocation) {
            console.log('üîÑ Starting live location tracking...');
            
            // Get initial position
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    updateLocation(position);
                    startWatchingLocation();
                },
                function(error) {
                    console.log('‚ùå Initial location error:', error.message);
                    showLocationError();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            console.log('‚ùå Geolocation not supported');
            showLocationError();
        }
    }

    // Start watching location changes
    function startWatchingLocation() {
        if (navigator.geolocation) {
            watchId = navigator.geolocation.watchPosition(
                function(position) {
                    updateLocation(position);
                },
                function(error) {
                    console.log('‚ùå Watch location error:', error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 5000
                }
            );
            isTracking = true;
            console.log('‚úÖ Live tracking started');
            
            // Show tracking indicator
            const trackingIndicator = document.getElementById('trackingIndicator');
            if (trackingIndicator) {
                trackingIndicator.classList.add('active');
            }
        }
    }

    // Update location on map
    function updateLocation(position) {
        const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        
        currentLocation = userLocation;
        
        // Center map on user location
        map.setCenter(userLocation);
        
        // Update or create user marker
        if (userMarker) {
            userMarker.setPosition(userLocation);
        } else {
            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: 'Your Live Location',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="16" cy="16" r="12" fill="#F43332" stroke="#FFFFFF" stroke-width="3"/>
                            <circle cx="16" cy="16" r="6" fill="#FFFFFF"/>
                            <circle cx="16" cy="16" r="2" fill="#F43332"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(32, 32),
                    anchor: new google.maps.Point(16, 16)
                },
                animation: google.maps.Animation.DROP
            });
        }
        
        // Add accuracy circle
        const accuracyCircle = new google.maps.Circle({
            strokeColor: '#F43332',
            strokeOpacity: 0.3,
            strokeWeight: 2,
            fillColor: '#F43332',
            fillOpacity: 0.1,
            map: map,
            center: userLocation,
            radius: position.coords.accuracy
        });
        
        // Remove previous accuracy circle after 5 seconds
        setTimeout(() => {
            accuracyCircle.setMap(null);
        }, 5000);
        
        console.log('üìç Location updated:', userLocation, 'Accuracy:', position.coords.accuracy + 'm');
    }

    // Stop live tracking
    function stopLiveTracking() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            isTracking = false;
            console.log('‚èπÔ∏è Live tracking stopped');
            
            // Hide tracking indicator
            const trackingIndicator = document.getElementById('trackingIndicator');
            if (trackingIndicator) {
                trackingIndicator.classList.remove('active');
            }
        }
    }

    // Show location error and fallback
    function showLocationError() {
        // Add a marker at Iligan City as fallback
        const iliganCity = { lat: 8.2474, lng: 124.2452 };
        
        userMarker = new google.maps.Marker({
            position: iliganCity,
            map: map,
            title: 'Iligan City (Location not available)',
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="8" fill="#FFA500" stroke="#FFFFFF" stroke-width="2"/>
                        <circle cx="12" cy="12" r="3" fill="#FFFFFF"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24),
                anchor: new google.maps.Point(12, 12)
            }
        });
    }

    // Go back to dashboard
    function goBack() {
        // Stop live tracking before leaving
        stopLiveTracking();
        window.location.href = '/rider/dashboard/';
    }

    // Zoom controls
    function zoomIn() {
        if (map && currentLocation) {
            const currentZoom = map.getZoom();
            const newZoom = Math.min(currentZoom + 1, 20); // Max zoom level 20
            
            map.setZoom(newZoom);
            map.setCenter(currentLocation);
            
            console.log('üîç Zoomed in to level:', newZoom);
        } else if (map) {
            // Fallback to Iligan City if no current location
            const iliganCity = { lat: 8.2474, lng: 124.2452 };
            const currentZoom = map.getZoom();
            const newZoom = Math.min(currentZoom + 1, 20);
            
            map.setZoom(newZoom);
            map.setCenter(iliganCity);
            
            console.log('üîç Zoomed in to level:', newZoom, '(Iligan City)');
        }
    }

    function zoomOut() {
        if (map && currentLocation) {
            const currentZoom = map.getZoom();
            const newZoom = Math.max(currentZoom - 1, 1); // Min zoom level 1
            
            map.setZoom(newZoom);
            map.setCenter(currentLocation);
            
            console.log('üîç Zoomed out to level:', newZoom);
        } else if (map) {
            // Fallback to Iligan City if no current location
            const iliganCity = { lat: 8.2474, lng: 124.2452 };
            const currentZoom = map.getZoom();
            const newZoom = Math.max(currentZoom - 1, 1);
            
            map.setZoom(newZoom);
            map.setCenter(iliganCity);
            
            console.log('üîç Zoomed out to level:', newZoom, '(Iligan City)');
        }
    }

    // Clean up when page is unloaded
    window.addEventListener('beforeunload', function() {
        stopLiveTracking();
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
    });
</script>

<style>
    /* Navigation Page Styles */
    .navigation-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }

    .map-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    /* Back Button */
    .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .back-button:hover {
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.05);
    }

    .back-button svg {
        color: #333;
        width: 20px;
        height: 20px;
    }

    /* Live Tracking Indicator */
    .tracking-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.8);
        color: #FFFFFF;
        padding: 8px 16px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }

    .tracking-indicator.active {
        opacity: 1;
        transform: translateY(0);
    }

    .tracking-dot {
        width: 8px;
        height: 8px;
        background-color: #00FF00;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 255, 0, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 255, 0, 0);
        }
    }

    /* Zoom Controls */
    .zoom-controls {
        position: absolute;
        top: 80px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .zoom-button {
        background-color: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 4px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .zoom-button:hover {
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .zoom-button:active {
        transform: scale(0.95);
    }

    .zoom-button svg {
        color: #333;
        width: 16px;
        height: 16px;
    }

    .zoom-in {
        border-radius: 4px 4px 0 0;
    }

    .zoom-out {
        border-radius: 0 0 4px 4px;
    }

    /* Bottom Container */
    .bottom-navigation-container {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: 20px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    }

    .download-message {
        background-color: #FFFFFF;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 20px;
        max-width: 500px;
        margin: 0 auto;
    }

    .download-icon {
        flex-shrink: 0;
        color: #F43332;
    }

    .download-content h3 {
        font-size: 18px;
        font-weight: 800;
        color: #333;
        margin: 0 0 8px 0;
    }

    .download-content p {
        font-size: 14px;
        font-weight: 300;
        color: #666;
        margin: 0 0 16px 0;
        line-height: 1.4;
    }

    .download-buttons {
        display: flex;
        gap: 12px;
    }

    .google-play-download {
        height: 40px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .google-play-download:hover {
        transform: scale(1.05);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .back-button {
            top: 15px;
            left: 15px;
            width: 44px;
            height: 44px;
        }

        .back-button svg {
            width: 18px;
            height: 18px;
        }

        .tracking-indicator {
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            font-size: 13px;
        }

        .zoom-controls {
            top: 70px;
            right: 15px;
        }

        .zoom-button {
            width: 36px;
            height: 36px;
        }

        .zoom-button svg {
            width: 14px;
            height: 14px;
        }

        .bottom-navigation-container {
            padding: 15px;
        }

        .download-message {
            padding: 20px;
            gap: 16px;
        }

        .download-content h3 {
            font-size: 16px;
        }

        .download-content p {
            font-size: 13px;
        }

        .google-play-download {
            height: 36px;
        }
    }

    @media (max-width: 480px) {
        .back-button {
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
        }

        .back-button svg {
            width: 16px;
            height: 16px;
        }

        .tracking-indicator {
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }

        .zoom-controls {
            top: 60px;
            right: 10px;
        }

        .zoom-button {
            width: 32px;
            height: 32px;
        }

        .zoom-button svg {
            width: 12px;
            height: 12px;
        }

        .bottom-navigation-container {
            padding: 10px;
        }

        .download-message {
            padding: 16px;
            gap: 12px;
            flex-direction: column;
            text-align: center;
        }

        .download-content h3 {
            font-size: 15px;
        }

        .download-content p {
            font-size: 12px;
        }

        .google-play-download {
            height: 32px;
        }
    }
</style>

{% endblock %}
