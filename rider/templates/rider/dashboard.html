{% extends 'components/rider/dashboard_base.html' %}

{% load static %}

{% if not user.is_authenticated %}
    <script>window.location.href = "/";</script>
{% endif %}

{% block content %}
{% include 'layout/rider/navbar.html' %}

<div class="main-container">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    <!-- Hero Section -->
    <div class="hero-container">
        <img class="hero-image" src="{% static 'icons/header.webp' %}" alt="Hero Background">
        
        <!-- Hero Content Overlay -->
        <div class="hero-content">
            <div class="hero-button">
                <span class="hero-button-text">Soti Delivery</span>
            </div>
            <div class="hero-title">
                <h1>Partner, {{ user.first_name }}!</h1>
        </div>
            
            <div class="main-info-container">
                <!-- Weather Container -->
                <div class="weather-container">
                    <div class="weather-text">
                        <span id="temperature">--</span><span class="degree-symbol">¬∞</span><span class="degree-unit">C</span>
            </div>
                    <div class="weather-description" id="weatherDescription">Loading weather...</div>
                    <div class="location-text" id="locationText">Getting location...</div>
                    <div class="weather-message" id="weatherMessage">üí¨ Safe delivery!</div>
            </div>

                <!-- Time Column -->
                <div class="time-column">
                    <div class="clock-container">
                        <div class="clock-text" id="currentTime">--:--</div>
                        <div class="clock-description">Current Time</div>
                    </div>
                    <div class="session-timer-container">
                        <div class="session-timer-text" id="sessionTimer">--:--</div>
                        <div class="session-timer-description">Session Time</div>
                    </div>
                </div>
            </div>
            </div>
        </div>

    <!-- Status Container -->
        <div class="status-container">
        <div class="status-content">
            <div class="status-text-container">
                <div class="status-title">Status: <span id="status">{{ rider.is_available|yesno:"Online,Offline" }}</span></div>
                <div class="status-subtitle" id="statusMessage">
                    {{ rider.is_available|yesno:"Open to any delivery,Turn on status to receive Delivery Assignments" }}
                </div>
            </div>
            <div class="toggle-button" id="toggleButton" onclick="toggleStatus()">
                <div class="toggle-circle" id="toggleCircle"></div>
            </div>
            </div>
        </div>

    <!-- Orders Container -->
    <div class="orders-container" id="ordersContainer">
        <div class="orders-content">
            <img class="orders-icon" src="{% static 'icons/foodPack.png' %}" alt="Orders">
            <div class="orders-text-container">
                <div class="orders-title" id="ordersTitle">Download the app to receive orders</div>
                <div class="view-orders-text">
                    <a href="/rider/orders/" class="cta-view-link"></a>
                    <img class="google-play-icon" src="{% static 'rider/images/googleplay.png' %}" alt="Google Play Store">
                </div>
            </div>
        </div>
 
        <!-- Offline Overlay -->
        <div class="offline-overlay" id="offlineOverlay" style="display: none;">
            <div class="offline-text">You're Offline</div>
            <div class="offline-subtext">Turn on your status to receive delivery assignments</div>
        </div>
    </div>

    <!-- Navigator Container -->
    <div class="navigator-container">
        <div class="navigator-content">
            <div class="navigator-text-container">
                <div class="navigator-title">Live route navigation</div>
                <div class="navigator-subtitle">free tier feature</div>
            </div>
            <button class="navigator-button" onclick="openNavigationPage()">Navigation</button>
        </div>
    </div>

    <!-- Assignments Section -->
    <div class="assignments-container">
        <div class="section-title">Recent Assignments</div>
        <div class="assignment-card">
            <div class="assignment-header">
                <div class="restaurant-name">üì± Mobile App Required</div>
                <div class="assignment-amount">üöÄ Get Started</div>
            </div>
            <div class="customer-name">Download or login to the official Soti Rider mobile app to view your recent assignments, track deliveries in real-time, and manage your earnings.</div>
            <div class="assignment-address">Experience the full power of our delivery platform with live order notifications, GPS navigation, and instant payment tracking.</div>
            <div class="assignment-footer">
                <div class="assignment-status">Available on Mobile</div>
                <div class="assignment-time">Download now</div>
            </div>
        </div>
    </div>

    <!-- Bottom Padding for Navigation -->
    <div class="bottom-padding"></div>
</div>

<script>
    // Status Toggle Functionality
    function toggleStatus() {
        fetch("{% url 'rider:toggle_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('status').innerText = data.new_status;
            
            // Update toggle button appearance
            const toggleButton = document.getElementById('toggleButton');
            const toggleCircle = document.getElementById('toggleCircle');
            const statusMessage = document.getElementById('statusMessage');
            const offlineOverlay = document.getElementById('offlineOverlay');

            if (data.new_status === 'Online') {
                toggleButton.classList.add('toggle-button-active');
                toggleCircle.classList.add('toggle-circle-active');
                statusMessage.innerText = 'Download the app to receive orders';
                offlineOverlay.style.display = 'none';
            } else {
                toggleButton.classList.remove('toggle-button-active');
                toggleCircle.classList.remove('toggle-circle-active');
                statusMessage.innerText = 'Turn on status to receive Delivery Assignments';
                offlineOverlay.style.display = 'flex';
            }
        });
    }

    // Initialize toggle button state
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleButton');
        const toggleCircle = document.getElementById('toggleCircle');
        const offlineOverlay = document.getElementById('offlineOverlay');
        
        {% if rider.is_available %}
            toggleButton.classList.add('toggle-button-active');
            toggleCircle.classList.add('toggle-circle-active');
            offlineOverlay.style.display = 'none';
        {% else %}
            offlineOverlay.style.display = 'flex';
        {% endif %}
    });

    // Order Count Updates
    function updateOrderCount() {
        fetch("{% url 'rider:get_order_count' %}")
            .then(response => response.json())
            .then(data => {
                const ordersTitle = document.getElementById('ordersTitle');
                if (data.count >= 1) {
                    ordersTitle.innerText = `${data.count} delivery orders found!`;
                } else {
                    ordersTitle.innerText = 'Download the app to receive orders';
                }
            });
    }

    // Earnings Updates
    function updateEarnings() {
    const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfTokenElement) {
        console.error("CSRF token not found.");
        return;
    }

    fetch("{% url 'rider:fetch_updated_earnings' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfTokenElement.value
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.total_earnings) {
                // Update earnings display if needed
                console.log('Updated earnings:', data.total_earnings);
        }
    })
    .catch(error => {
        console.error('Error fetching updated earnings:', error);
    });
}

    // Session Timer
    let sessionStartTime = Date.now();
    
    // Time Updates
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
    }
    
    // Session Timer Updates
    function updateSessionTimer() {
        const currentTime = Date.now();
        const sessionDuration = currentTime - sessionStartTime;
        
        // Convert milliseconds to hours, minutes, seconds
        const hours = Math.floor(sessionDuration / (1000 * 60 * 60));
        const minutes = Math.floor((sessionDuration % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((sessionDuration % (1000 * 60)) / 1000);
        
        // Format as HH:MM:SS
        const sessionTimeString = 
            hours.toString().padStart(2, '0') + ':' +
            minutes.toString().padStart(2, '0') + ':' +
            seconds.toString().padStart(2, '0');
            
        document.getElementById('sessionTimer').textContent = sessionTimeString;
    }

    // Weather API using Open-Meteo (FREE, no API key required)
    async function updateWeather() {
        try {
            // Iligan City coordinates
            const latitude = 8.2474;
            const longitude = 124.2452;
            
            console.log('üå§Ô∏è Fetching weather data for Iligan City:', latitude, longitude);
            
            // Open-Meteo API endpoint (FREE, no API key required!)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.current_weather) {
                throw new Error('Invalid response from Open-Meteo API');
            }
            
            console.log('‚úÖ Weather data fetched successfully:', {
                temperature: data.current_weather.temperature,
                condition: data.current_weather.weathercode,
                windSpeed: data.current_weather.windspeed
            });
            
            // Update temperature
            const temperature = Math.round(data.current_weather.temperature);
            document.getElementById('temperature').textContent = temperature;
            
            // Update weather description
            const weatherDescription = getWeatherDescription(data.current_weather.weathercode);
            document.getElementById('weatherDescription').textContent = weatherDescription;
            
            // Update location
            document.getElementById('locationText').textContent = 'Iligan City, Philippines';
            
            // Update weather message
            const weatherMessage = getWeatherMessage(data.current_weather.weathercode, temperature, data.current_weather.windspeed);
            document.getElementById('weatherMessage').textContent = weatherMessage;
            
        } catch (error) {
            console.log('‚ùå Weather API error:', error.message);
            // Fallback weather data
            document.getElementById('temperature').textContent = '28';
            document.getElementById('weatherDescription').textContent = 'Partly Cloudy';
            document.getElementById('locationText').textContent = 'Iligan City, Philippines';
            document.getElementById('weatherMessage').textContent = 'üí¨ Safe delivery!';
        }
    }
    
    // Get weather condition description from weather code
    function getWeatherDescription(weatherCode) {
        const weatherCodes = {
            0: 'Clear sky',
            1: 'Mainly clear',
            2: 'Partly cloudy',
            3: 'Overcast',
            45: 'Fog',
            48: 'Depositing rime fog',
            51: 'Light drizzle',
            53: 'Moderate drizzle',
            55: 'Dense drizzle',
            56: 'Light freezing drizzle',
            57: 'Dense freezing drizzle',
            61: 'Slight rain',
            63: 'Moderate rain',
            65: 'Heavy rain',
            66: 'Light freezing rain',
            67: 'Heavy freezing rain',
            71: 'Slight snow fall',
            73: 'Moderate snow fall',
            75: 'Heavy snow fall',
            77: 'Snow grains',
            80: 'Slight rain showers',
            81: 'Moderate rain showers',
            82: 'Violent rain showers',
            85: 'Slight snow showers',
            86: 'Heavy snow showers',
            95: 'Thunderstorm',
            96: 'Thunderstorm with slight hail',
            99: 'Thunderstorm with heavy hail'
        };
        return weatherCodes[weatherCode] || 'Partly cloudy';
    }

    // Get friendly message based on weather conditions
    function getWeatherMessage(weatherCode, temperature, windSpeed) {
        // Rain conditions
        if (weatherCode >= 51 && weatherCode <= 67) {
            return 'üåßÔ∏è Bring your raincoat!';
        }
        if (weatherCode >= 80 && weatherCode <= 82) {
            return 'üå¶Ô∏è Wear your raincoat!';
        }
        
        // Snow conditions
        if (weatherCode >= 71 && weatherCode <= 77) {
            return '‚ùÑÔ∏è Be careful on slippery roads!';
        }
        
        // Thunderstorm
        if (weatherCode >= 95 && weatherCode <= 99) {
            return '‚õàÔ∏è Stay at home during the storm!';
        }
        
        // High wind
        if (windSpeed > 20) {
            return 'üí® Strong winds - drive carefully!';
        }
        
        // Hot weather
        if (temperature > 35) {
            return 'üå°Ô∏è Stay hydrated in this heat!';
        }
        
        // Cold weather
        if (temperature < 10) {
            return 'üß• Bundle up - it\'s chilly!';
        }
        
        // Clear weather
        if (weatherCode === 0 || weatherCode === 1) {
            return '‚òÄÔ∏è Perfect weather for deliveries!';
        }
        
        // Default
        return 'üí¨ Safe delivery!';
    }

    // Navigation functionality
    function openNavigationPage() {
        window.location.href = '/rider/navigation/';
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        updateSessionTimer();
        updateWeather();
        updateOrderCount();
        updateEarnings();
        
        // Update time and session timer every second
        setInterval(updateTime, 1000);
        setInterval(updateSessionTimer, 1000);
        
        // Update other data periodically
        setInterval(updateOrderCount, 30000);
        setInterval(updateEarnings, 60000);
    });
</script>
    

{% endblock %}