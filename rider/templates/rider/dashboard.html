{% extends 'components/rider/dashboard_base.html' %}

{% load static %}

{% if not user.is_authenticated %}
    <script>window.location.href = "/";</script>
{% endif %}

{% block content %}
{% include 'layout/rider/navbar.html' %}

<div class="main-container">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    <!-- Hero Section -->
    <div class="hero-container">
        <img class="hero-image" src="{% static 'icons/header.webp' %}" alt="Hero Background">
        
        <!-- Hero Content Overlay -->
        <div class="hero-content">
            <div class="hero-button">
                <span class="hero-button-text">Soti Delivery</span>
            </div>
            <div class="hero-title">
                <h1>Partner, {{ user.first_name }}!</h1>
            </div>
            
            <div class="main-info-container">
                <!-- Weather Container -->
                <div class="weather-container">
                    <div class="weather-text">
                        <span id="temperature">--</span><span class="degree-symbol">°</span><span class="degree-unit">C</span>
                    </div>
                    <div class="weather-description" id="weatherDescription">Loading weather...</div>
                    <div class="location-text" id="locationText">Getting location...</div>
                </div>
                
                <!-- Time Column -->
                <div class="time-column">
                    <div class="clock-container">
                        <div class="clock-text" id="currentTime">--:--</div>
                        <div class="clock-description">Current Time</div>
                    </div>
                    <div class="session-timer-container">
                        <div class="session-timer-text" id="sessionTimer">--:--</div>
                        <div class="session-timer-description">Session Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Container -->
    <div class="status-container">
        <div class="status-content">
            <div class="status-text-container">
                <div class="status-title">Status: <span id="status">{{ rider.is_available|yesno:"Online,Offline" }}</span></div>
                <div class="status-subtitle" id="statusMessage">
                    {{ rider.is_available|yesno:"Open to any delivery,Turn on status to receive Delivery Assignments" }}
                </div>
            </div>
            <div class="toggle-button" id="toggleButton" onclick="toggleStatus()">
                <div class="toggle-circle" id="toggleCircle"></div>
            </div>
        </div>
    </div>

    <!-- Orders Container -->
    <div class="orders-container" id="ordersContainer">
        <div class="orders-content">
            <img class="orders-icon" src="{% static 'icons/foodPack.png' %}" alt="Orders">
            <div class="orders-text-container">
                <div class="orders-title" id="ordersTitle">Download the app to receive orders</div>
                <div class="view-orders-text">
                    <a href="/rider/orders/" class="cta-view-link">Download &gt;</a>
                    <img class="google-play-icon" src="{% static 'rider/images/googleplay.png' %}" alt="Google Play Store">
                </div>
            </div>
        </div>
        
        <!-- Offline Overlay -->
        <div class="offline-overlay" id="offlineOverlay" style="display: none;">
            <div class="offline-text">You're Offline</div>
            <div class="offline-subtext">Turn on your status to receive delivery assignments</div>
        </div>
    </div>

    <!-- Assignments Section -->
    <div class="assignments-container">
        <div class="section-title">Recent Assignments</div>
        <div class="assignment-card">
            <div class="assignment-header">
                <div class="restaurant-name">Sample Restaurant</div>
                <div class="assignment-amount">₱150.00</div>
            </div>
            <div class="customer-name">Customer: John Doe</div>
            <div class="assignment-address">123 Main Street, City</div>
            <div class="assignment-footer">
                <div class="assignment-status">Completed</div>
                <div class="assignment-time">2 hours ago</div>
            </div>
        </div>
    </div>

    <!-- Bottom Padding for Navigation -->
    <div class="bottom-padding"></div>
</div>

<script>
    // Status Toggle Functionality
    function toggleStatus() {
        fetch("{% url 'rider:toggle_status' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('status').innerText = data.new_status;
            
            // Update toggle button appearance
            const toggleButton = document.getElementById('toggleButton');
            const toggleCircle = document.getElementById('toggleCircle');
            const statusMessage = document.getElementById('statusMessage');
            const offlineOverlay = document.getElementById('offlineOverlay');
            
            if (data.new_status === 'Online') {
                toggleButton.classList.add('toggle-button-active');
                toggleCircle.classList.add('toggle-circle-active');
                statusMessage.innerText = 'Download the app to receive orders';
                offlineOverlay.style.display = 'none';
            } else {
                toggleButton.classList.remove('toggle-button-active');
                toggleCircle.classList.remove('toggle-circle-active');
                statusMessage.innerText = 'Turn on status to receive Delivery Assignments';
                offlineOverlay.style.display = 'flex';
            }
        });
    }

    // Initialize toggle button state
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleButton');
        const toggleCircle = document.getElementById('toggleCircle');
        const offlineOverlay = document.getElementById('offlineOverlay');
        
        {% if rider.is_available %}
            toggleButton.classList.add('toggle-button-active');
            toggleCircle.classList.add('toggle-circle-active');
            offlineOverlay.style.display = 'none';
        {% else %}
            offlineOverlay.style.display = 'flex';
        {% endif %}
    });

    // Order Count Updates
    function updateOrderCount() {
        fetch("{% url 'rider:get_order_count' %}")
            .then(response => response.json())
            .then(data => {
                const ordersTitle = document.getElementById('ordersTitle');
                if (data.count >= 1) {
                    ordersTitle.innerText = `${data.count} delivery orders found!`;
                } else {
                    ordersTitle.innerText = 'Download the app to receive orders';
                }
            });
    }

    // Earnings Updates
    function updateEarnings() {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenElement) {
            console.error("CSRF token not found.");
            return;
        }

        fetch("{% url 'rider:fetch_updated_earnings' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfTokenElement.value
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.total_earnings) {
                // Update earnings display if needed
                console.log('Updated earnings:', data.total_earnings);
            }
        })
        .catch(error => {
            console.error('Error fetching updated earnings:', error);
        });
    }

    // Session Timer
    let sessionStartTime = Date.now();
    
    // Time Updates
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('currentTime').textContent = timeString;
    }
    
    // Session Timer Updates
    function updateSessionTimer() {
        const currentTime = Date.now();
        const sessionDuration = currentTime - sessionStartTime;
        
        // Convert milliseconds to hours, minutes, seconds
        const hours = Math.floor(sessionDuration / (1000 * 60 * 60));
        const minutes = Math.floor((sessionDuration % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((sessionDuration % (1000 * 60)) / 1000);
        
        // Format as HH:MM:SS
        const sessionTimeString = 
            hours.toString().padStart(2, '0') + ':' +
            minutes.toString().padStart(2, '0') + ':' +
            seconds.toString().padStart(2, '0');
            
        document.getElementById('sessionTimer').textContent = sessionTimeString;
    }

    // Weather API (placeholder - you can integrate with a real weather API)
    function updateWeather() {
        // Placeholder weather data
        document.getElementById('temperature').textContent = '25';
        document.getElementById('weatherDescription').textContent = 'Partly Cloudy';
        document.getElementById('locationText').textContent = 'Manila, Philippines';
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        updateSessionTimer();
        updateWeather();
        updateOrderCount();
        updateEarnings();
        
        // Update time and session timer every second
        setInterval(updateTime, 1000);
        setInterval(updateSessionTimer, 1000);
        
        // Update other data periodically
        setInterval(updateOrderCount, 30000);
        setInterval(updateEarnings, 60000);
    });
</script>
    

{% endblock %}